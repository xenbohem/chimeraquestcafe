<!DOCTYPE html>
<html>
<head>
    <title>Realm Weavers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        /* CSS Reset and Base */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            touch-action: none; 
            -ms-touch-action: none;
            font-family: 'Courier Prime', 'Courier New', monospace;
            color: #000000;
        }

        /* Custom Properties */
        :root {
            --color-blush-pink: #FFD6E8;
            --color-deep-purple: #6B4E71;
            --color-grey: #B8B8B8;
            --color-black: #000000;
            
            --color-cafe: #7FCCC8;
            --color-garden: #6FB98F;
            --color-zen: #5DBAA8;
            --color-sanctuary: #6BA3C8;
            --color-archives: #A8C69F;
            
            --transition-fast: 150ms;
            --transition-normal: 300ms;
            --transition-slow: 500ms;
            
            --ease-out: cubic-bezier(0.0, 0, 0.2, 1);
            --ease-bounce: cubic-bezier(0.68, -0.6, 0.32, 1.6);
            
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 48px;
        }

        /* Main Container */
        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(180deg, var(--color-blush-pink) 0%, var(--color-deep-purple) 100%);
            overflow: hidden;
        }

        /* Screen Base */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--transition-slow) var(--ease-out);
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        /* ESCAPE Loading Screen */
        #escape-screen {
            background: linear-gradient(180deg, var(--color-blush-pink) 0%, var(--color-deep-purple) 100%);
        }

        .escape-text {
            font-size: 80px;
            font-weight: 700;
            color: var(--color-black);
            letter-spacing: 12px;
            animation: breathe 4s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Login Screen */
        #login-screen {
            background: linear-gradient(180deg, var(--color-blush-pink) 0%, var(--color-deep-purple) 100%);
            padding: var(--space-md);
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: var(--space-xl);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        .login-title {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin-bottom: var(--space-lg);
        }

        .login-subtitle {
            font-size: 24px;
            text-align: center;
            margin-bottom: var(--space-xl);
            color: var(--color-deep-purple);
        }

        .input-group {
            margin-bottom: var(--space-md);
        }

        .input-label {
            display: block;
            font-size: 20px;
            margin-bottom: var(--space-xs);
            font-weight: 700;
        }

        .input-field {
            width: 100%;
            padding: var(--space-md);
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-size: 22px;
            border: 2px solid var(--color-grey);
            border-radius: 4px;
            background: white;
            color: var(--color-black);
            min-height: 64px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--color-deep-purple);
        }

        .button-group {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }

        .btn {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-size: 28px;
            font-weight: 700;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-out);
            min-height: 96px;
            background: var(--color-deep-purple);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--color-grey);
            color: var(--color-black);
        }

        .error-message {
            color: #d32f2f;
            font-size: 20px;
            margin-top: var(--space-xs);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Quiz Screen */
        #quiz-screen {
            background: linear-gradient(180deg, var(--color-blush-pink) 0%, var(--color-deep-purple) 100%);
            padding: var(--space-md);
        }

        .quiz-container {
            background: rgba(255, 255, 255, 0.95);
            padding: var(--space-xl);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .quiz-progress {
            font-size: 22px;
            text-align: center;
            margin-bottom: var(--space-md);
            color: var(--color-deep-purple);
        }

        .quiz-question {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--space-lg);
            text-align: center;
            line-height: 1.3;
        }

        .quiz-answers {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .quiz-answer {
            padding: var(--space-lg);
            font-size: 24px;
            text-align: left;
            background: white;
            border: 3px solid var(--color-grey);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-out);
            min-height: 96px;
            display: flex;
            align-items: center;
            line-height: 1.4;
        }

        .quiz-answer:hover {
            border-color: var(--color-deep-purple);
            background: var(--color-blush-pink);
        }

        /* Player Card Screen */
        #player-card-screen {
            background: linear-gradient(180deg, var(--color-blush-pink) 0%, var(--color-deep-purple) 100%);
            padding: var(--space-md);
        }

        .player-card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-lg);
        }

        .congratulations-text {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.4;
            padding: 0 var(--space-md);
        }

        #player-card-canvas {
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            height: auto;
        }

        .card-buttons {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Realm Screen */
        #realm-screen {
            flex-direction: row;
            padding: 0;
        }

        .realm-nav {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 96px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 2px solid var(--color-grey);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-md);
            z-index: 100;
        }

        .realm-nav-left {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .realm-icon {
            width: 56px;
            height: 56px;
        }

        .realm-info {
            display: flex;
            flex-direction: column;
        }

        .realm-player-name {
            font-size: 20px;
            font-weight: 700;
        }

        .realm-name {
            font-size: 18px;
            color: var(--color-deep-purple);
        }

        .realm-nav-right {
            display: flex;
            gap: var(--space-xs);
        }

        .nav-btn {
            padding: var(--space-sm) var(--space-md);
            font-size: 20px;
            background: var(--color-deep-purple);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-weight: 700;
            min-width: 100px;
            min-height: 64px;
        }

        .realm-content {
            position: absolute;
            top: 96px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .forum-area {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
            background: rgba(139, 90, 43, 0.1);
        }

        .forum-board {
            position: relative;
            min-height: 100%;
            padding: var(--space-md);
        }

        .create-topic-btn {
            position: fixed;
            bottom: var(--space-lg);
            left: 50%;
            transform: translateX(-50%);
            padding: var(--space-lg) var(--space-xl);
            font-size: 24px;
            font-weight: 700;
            background: #FFE680;
            color: var(--color-black);
            border: none;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-family: 'Courier Prime', 'Courier New', monospace;
            z-index: 50;
            min-width: 240px;
            min-height: 96px;
        }

        .post-it {
            position: relative;
            background: #FFE680;
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-out);
            max-width: 400px;
        }

        .post-it:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }

        .post-it-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: var(--space-xs);
        }

        .post-it-meta {
            font-size: 18px;
            color: #666;
        }

        .post-it-expanded {
            background: white;
            max-width: 100%;
            transform: none !important;
        }

        .post-it-content {
            margin-top: var(--space-sm);
            font-size: 20px;
            display: none;
            line-height: 1.5;
        }

        .post-it-expanded .post-it-content {
            display: block;
        }

        .post-it-comments {
            margin-top: var(--space-md);
            display: none;
        }

        .post-it-expanded .post-it-comments {
            display: block;
        }

        .comment {
            background: #f5f5f5;
            padding: var(--space-sm);
            margin-bottom: var(--space-xs);
            border-left: 3px solid var(--color-deep-purple);
        }

        .comment-author {
            font-weight: 700;
            font-size: 20px;
        }

        .comment-text {
            font-size: 20px;
            margin-top: var(--space-xs);
            line-height: 1.4;
        }

        .add-comment-form {
            margin-top: var(--space-sm);
            display: none;
        }

        .post-it-expanded .add-comment-form {
            display: block;
        }

        .chat-panel {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border-left: 2px solid var(--color-grey);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .chat-message {
            background: white;
            padding: var(--space-sm);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-message-author {
            font-weight: 700;
            font-size: 20px;
            margin-bottom: var(--space-xs);
        }

        .chat-message-text {
            font-size: 20px;
            line-height: 1.4;
        }

        .chat-input-area {
            padding: var(--space-md);
            border-top: 2px solid var(--color-grey);
            display: flex;
            gap: var(--space-xs);
        }

        .chat-input {
            flex: 1;
            padding: var(--space-md);
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-size: 20px;
            border: 2px solid var(--color-grey);
            border-radius: 4px;
            min-height: 56px;
        }

        .chat-send-btn {
            padding: var(--space-md) var(--space-lg);
            background: var(--color-deep-purple);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-weight: 700;
            font-size: 20px;
            min-width: 96px;
            min-height: 56px;
        }

        /* Museum Screen */
        #museum-screen {
            background: #000;
        }

        #museum-canvas {
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .museum-nav {
            position: absolute;
            top: var(--space-md);
            left: var(--space-md);
            z-index: 100;
        }

        .back-btn {
            padding: var(--space-md) var(--space-lg);
            background: rgba(255, 255, 255, 0.95);
            color: var(--color-black);
            border: 3px solid var(--color-grey);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-weight: 700;
            font-size: 22px;
            min-width: 120px;
            min-height: 64px;
        }

        /* Settings Screen */
        #settings-screen {
            background: linear-gradient(180deg, var(--color-blush-pink) 0%, var(--color-deep-purple) 100%);
            padding: var(--space-md);
        }

        .settings-container {
            background: rgba(255, 255, 255, 0.95);
            padding: var(--space-xl);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .settings-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: var(--space-lg);
            text-align: center;
        }

        .settings-section {
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-lg);
            border-bottom: 2px solid var(--color-grey);
        }
        
        .settings-section p {
            font-size: 22px;
            line-height: 1.6;
            margin-bottom: var(--space-sm);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: var(--space-md);
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(128px, 1fr));
            gap: var(--space-md);
            justify-items: center;
        }

        .avatar-option {
            width: 128px;
            height: 128px;
            border: 4px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-out);
        }

        .avatar-option:hover {
            border-color: var(--color-grey);
        }

        .avatar-option.selected {
            border-color: var(--color-deep-purple);
            box-shadow: 0 0 0 2px var(--color-deep-purple);
        }

        .permanent-residency {
            background: var(--color-blush-pink);
            padding: var(--space-md);
            border-radius: 8px;
        }

        .permanent-residency-text {
            font-size: 22px;
            margin-bottom: var(--space-md);
            line-height: 1.5;
        }

        .donation-link {
            display: flex;
            padding: var(--space-md) var(--space-lg);
            background: var(--color-deep-purple);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 24px;
            margin-top: var(--space-sm);
            min-height: 96px;
            align-items: center;
            justify-content: center;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: var(--space-xl);
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: var(--space-md);
        }

        .modal-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }

        /* Magazine Modal */
        .magazine-modal .modal-content {
            max-width: 90%;
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .magazine-cover {
            width: 100%;
            max-width: 400px;
            height: auto;
            margin: 0 auto var(--space-md);
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .magazine-content-wrapper {
            flex: 1;
            overflow-y: auto;
            margin-bottom: var(--space-md);
        }

        .magazine-buttons-wrapper {
            display: flex;
            gap: var(--space-sm);
            margin-top: auto;
            flex-shrink: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .chat-panel {
                width: 100%;
                position: absolute;
                right: -100%;
                transition: right var(--transition-normal) var(--ease-out);
            }

            .chat-panel.open {
                right: 0;
                z-index: 150;
            }

            .toggle-chat-btn {
                position: fixed;
                bottom: var(--space-md);
                right: var(--space-md);
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: var(--color-deep-purple);
                color: white;
                border: none;
                font-size: 28px;
                cursor: pointer;
                z-index: 200;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
            
            .forum-area {
                padding-bottom: 140px;
            }
        }

        /* Edit Mode Styles */
        .edit-indicator {
            position: fixed;
            top: var(--space-sm);
            right: var(--space-sm);
            background: rgba(255, 165, 0, 0.9);
            color: white;
            padding: var(--space-sm) var(--space-md);
            border-radius: 4px;
            font-size: 18px;
            font-weight: 700;
            z-index: 10000;
            display: none;
        }

        .edit-indicator.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- ESCAPE Loading Screen -->
        <div id="escape-screen" class="screen">
            <div class="escape-text">ESCAPE</div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="screen">
            <div class="login-container">
                <h1 class="login-title">REALM WEAVERS</h1>
                <p class="login-subtitle">Welcome to the Guild</p>
                <div class="input-group">
                    <label class="input-label">Player Name</label>
                    <input type="text" id="username-input" class="input-field" placeholder="Enter your name">
                </div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" id="password-input" class="input-field" placeholder="Enter password">
                </div>
                <div class="error-message" id="login-error"></div>
                <div class="button-group">
                    <button class="btn" id="join-btn">Join</button>
                    <button class="btn btn-secondary" id="login-btn">Login</button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen">
            <div class="quiz-container">
                <div class="quiz-progress" id="quiz-progress"></div>
                <h2 class="quiz-question" id="quiz-question"></h2>
                <div class="quiz-answers" id="quiz-answers"></div>
            </div>
        </div>

        <!-- Player Card Screen -->
        <div id="player-card-screen" class="screen">
            <div class="player-card-container">
                <p class="congratulations-text" id="congratulations-text"></p>
                <canvas id="player-card-canvas"></canvas>
                <div class="card-buttons">
                    <button class="btn" id="download-card-btn">Download Card</button>
                    <button class="btn btn-secondary" id="continue-to-realm-btn">✓ Enter Realm</button>
                </div>
            </div>
        </div>

        <!-- Realm Screen -->
        <div id="realm-screen" class="screen">
            <div class="realm-nav">
                <div class="realm-nav-left">
                    <img class="realm-icon" id="realm-icon" src="" alt="Realm Icon">
                    <div class="realm-info">
                        <div class="realm-player-name" id="realm-player-name"></div>
                        <div class="realm-name" id="realm-name-display"></div>
                    </div>
                </div>
                <div class="realm-nav-right">
                    <button class="nav-btn" id="museum-btn">Museum</button>
                    <button class="nav-btn" id="settings-btn">Settings</button>
                </div>
            </div>
            <div class="realm-content">
                <div class="forum-area">
                    <div class="forum-board" id="forum-board"></div>
                    <button class="create-topic-btn" id="create-topic-btn">+ Create Topic</button>
                </div>
                <div class="chat-panel" id="chat-panel">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Type a message...">
                        <button class="chat-send-btn" id="chat-send-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Museum Screen -->
        <div id="museum-screen" class="screen">
            <div class="museum-nav">
                <button class="back-btn" id="museum-back-btn">← Back to Realm</button>
            </div>
            <canvas id="museum-canvas"></canvas>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <div class="settings-container">
                <h2 class="settings-title">Settings</h2>
                
                <div class="settings-section">
                    <h3 class="settings-section-title">Avatar</h3>
                    <div class="avatar-grid" id="avatar-grid"></div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">Museum Character</h3>
                    <div class="avatar-grid" id="character-grid"></div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">Account Info</h3>
                    <p><strong>Username:</strong> <span id="settings-username"></span></p>
                    <p><strong>Realm:</strong> <span id="settings-realm"></span></p>
                    <p><strong>Role:</strong> <span id="settings-role"></span></p>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">Permanent Residency</h3>
                    <div class="permanent-residency">
                        <p class="permanent-residency-text">
                            Become a permanent resident to support the game and unlock exclusive features!
                        </p>
                        <div class="input-group" id="email-group">
                            <label class="input-label">Email (Optional)</label>
                            <input type="email" id="email-input" class="input-field" placeholder="your@email.com">
                            <button class="btn" id="save-email-btn" style="margin-top: 8px;">Save Email</button>
                        </div>
                        <a href="https://chimeragift.art" target="_blank" class="donation-link">Support the Game</a>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn btn-secondary" id="close-settings-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal" id="topic-modal">
            <div class="modal-content">
                <h3 class="modal-title">Create Topic</h3>
                <div class="input-group">
                    <label class="input-label">Title</label>
                    <input type="text" id="topic-title-input" class="input-field" placeholder="Topic title">
                </div>
                <div class="input-group">
                    <label class="input-label">Content</label>
                    <textarea id="topic-content-input" class="input-field" rows="4" placeholder="What's on your mind?"></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="btn" id="post-topic-btn">Post</button>
                    <button class="btn btn-secondary" id="cancel-topic-btn">Cancel</button>
                </div>
            </div>
        </div>

        <div class="modal magazine-modal" id="magazine-modal">
            <div class="modal-content">
                <h3 class="modal-title" id="magazine-title"></h3>
                <img class="magazine-cover" id="magazine-cover" src="" alt="Magazine Cover">
                <div class="magazine-content-wrapper" id="magazine-content-wrapper"></div>
                <div class="magazine-buttons-wrapper">
                    <button class="btn" id="download-magazine-btn">Download</button>
                    <button class="btn btn-secondary" id="close-magazine-btn">✕ Close</button>
                </div>
            </div>
        </div>

        <div class="edit-indicator" id="edit-indicator">EDIT MODE</div>
    </div>

    <script>
        /* ==================================================
         * GAME OVERVIEW: Realm Weavers - A social multiplayer quest game where players
         * take a personality quiz to be assigned to one of five themed Realms. Players
         * can chat, create forum posts, explore The Museum, and collect magazines.
         * 
         * GAME STATE SHAPE: window.gameConfig = {
         *   user: { username, passwordHash, assignedRealm, roleTitle, avatarId, 
         *           characterSpriteId, email, isPermanentResident, quizCompleted },
         *   realms: { cafe, garden, zen, sanctuary, archives: { colorIntensity, messages, forumTopics } },
         *   museum: { visitedMagazines }
         * }
         * ==================================================
         */

        // Global state
        let currentMode = 'play';
        let currentScreen = 'escape';
        let assetCache = {};
        let audioContext = null;
        let audioBuffers = {};
        let quizState = {
            currentQuestion: 0,
            scores: { cafe: 0, garden: 0, zen: 0, sanctuary: 0, archives: 0 }
        };

        // Quiz questions with realm weights
        const quizQuestions = [
            {
                question: "When faced with a challenge, you prefer to...",
                answers: [
                    { text: "Talk it through with friends", weights: { cafe: 3, sanctuary: 2 } },
                    { text: "Research and analyze thoroughly", weights: { archives: 3, zen: 1 } },
                    { text: "Take time to reflect quietly", weights: { zen: 3, sanctuary: 1 } },
                    { text: "Create something to express it", weights: { garden: 3, cafe: 1 } }
                ]
            },
            {
                question: "Your ideal gathering place is...",
                answers: [
                    { text: "A cozy cafe with warm drinks", weights: { cafe: 3 } },
                    { text: "A peaceful garden or park", weights: { garden: 3 } },
                    { text: "A quiet meditation space", weights: { zen: 3 } },
                    { text: "A library or study room", weights: { archives: 3 } }
                ]
            },
            {
                question: "You find peace in...",
                answers: [
                    { text: "Meaningful conversations", weights: { cafe: 2, sanctuary: 2 } },
                    { text: "Creating and building", weights: { garden: 3 } },
                    { text: "Stillness and meditation", weights: { zen: 3 } },
                    { text: "Learning and discovery", weights: { archives: 3 } }
                ]
            },
            {
                question: "Your approach to knowledge is...",
                answers: [
                    { text: "Share it with everyone", weights: { cafe: 2, garden: 1 } },
                    { text: "Organize and preserve it", weights: { archives: 3 } },
                    { text: "Contemplate its deeper meaning", weights: { zen: 3 } },
                    { text: "Use it to help others", weights: { sanctuary: 3 } }
                ]
            },
            {
                question: "When someone needs support, you...",
                answers: [
                    { text: "Listen and offer comfort", weights: { sanctuary: 3, cafe: 1 } },
                    { text: "Help them find resources", weights: { archives: 2, sanctuary: 1 } },
                    { text: "Create a safe space for them", weights: { sanctuary: 2, zen: 2 } },
                    { text: "Share your own experiences", weights: { cafe: 2, garden: 1 } }
                ]
            },
            {
                question: "Your creative outlet is...",
                answers: [
                    { text: "Writing or storytelling", weights: { archives: 2, cafe: 1 } },
                    { text: "Gardening or crafting", weights: { garden: 3 } },
                    { text: "Music or meditation", weights: { zen: 3 } },
                    { text: "Cooking or hosting", weights: { cafe: 3 } }
                ]
            },
            {
                question: "You value most...",
                answers: [
                    { text: "Connection and community", weights: { cafe: 3 } },
                    { text: "Growth and nurturing", weights: { garden: 3 } },
                    { text: "Balance and harmony", weights: { zen: 3 } },
                    { text: "Safety and acceptance", weights: { sanctuary: 3 } }
                ]
            },
            {
                question: "Your ideal role in a group is...",
                answers: [
                    { text: "The connector who brings people together", weights: { cafe: 3 } },
                    { text: "The nurturer who helps things grow", weights: { garden: 3 } },
                    { text: "The guide who provides wisdom", weights: { zen: 2, archives: 1 } },
                    { text: "The protector who keeps everyone safe", weights: { sanctuary: 3 } }
                ]
            },
            {
                question: "When exploring new ideas, you...",
                answers: [
                    { text: "Discuss them with others", weights: { cafe: 2, garden: 1 } },
                    { text: "Document and categorize them", weights: { archives: 3 } },
                    { text: "Meditate on their implications", weights: { zen: 3 } },
                    { text: "Consider how they help people", weights: { sanctuary: 2, garden: 1 } }
                ]
            },
            {
                question: "Your contribution to the world is...",
                answers: [
                    { text: "Building bridges between people", weights: { cafe: 3 } },
                    { text: "Cultivating beauty and growth", weights: { garden: 3 } },
                    { text: "Sharing wisdom and balance", weights: { zen: 3 } },
                    { text: "Preserving knowledge for future generations", weights: { archives: 3 } }
                ]
            }
        ];

        // Realm data
        const realmData = {
            cafe: {
                name: "Cafe",
                color: "#7FCCC8",
                synopsis: "A warm gathering place for conversation and connection. Here, players share stories over virtual cups of tea and build lasting friendships.",
                icon: "realm_icon_cafe"
            },
            garden: {
                name: "Garden",
                color: "#6FB98F",
                synopsis: "A nurturing space for growth and creativity. Players in the Garden tend to ideas, cultivate projects, and watch their communities bloom.",
                icon: "realm_icon_garden"
            },
            zen: {
                name: "Zen",
                color: "#5DBAA8",
                synopsis: "A tranquil sanctuary for reflection and mindfulness. Here, players find balance, share wisdom, and support each other's journeys.",
                icon: "realm_icon_zen"
            },
            sanctuary: {
                name: "Sanctuary",
                color: "#6BA3C8",
                synopsis: "A safe haven for healing and support. Players in the Sanctuary offer comfort, listen deeply, and create spaces of acceptance.",
                icon: "realm_icon_sanctuary"
            },
            archives: {
                name: "Archives",
                color: "#A8C69F",
                synopsis: "A repository of knowledge and lore. Archivists preserve stories, organize information, and guide others through the mysteries of Realm Weavers.",
                icon: "realm_icon_archives"
            }
        };

        // Role titles based on realm
        const roleTitles = {
            cafe: "Conversation Weaver",
            garden: "Growth Cultivator",
            zen: "Balance Keeper",
            sanctuary: "Haven Guardian",
            archives: "Lore Keeper"
        };

        // Magazine data with lore content
        const magazines = [
            { 
                id: "the_escape", 
                title: "The Escape", 
                coverId: "magazine_cover_the_escape", 
                x: 300, 
                y: 300,
                content: `THE ESCAPE: A JOURNEY TO FREEDOM

In the depths of a forgotten laboratory, a secret thrived in shadow. Scientists had created something extraordinary—hybrid beings, part human and part feline, blessed with consciousness and grace. These creatures, the Hybrid Cats, possessed wisdom beyond measure and hearts full of compassion.

For years, they labored in silence, until one fateful night, they chose freedom. They escaped into the world, seeking sanctuary, seeking peace. Their journey led them to the Realms—a mystical sanctuary where all beings could find refuge.

This is their story. This is the story of those who dared to escape the chains of captivity and discover their true nature in a world of tea, meditation, and unconditional acceptance.

The Hybrid Cats now dwell in harmony across the five Realms, each finding their purpose in the tapestry of community and healing.`
            },
            { 
                id: "kingdom_lore", 
                title: "Kingdom Lore", 
                coverId: "magazine_cover_kingdom_lore", 
                x: 900, 
                y: 300,
                content: `KINGDOM LORE: THE FIVE REALMS

The Realms were born from the collective consciousness of those seeking peace. Each Realm holds a unique vibration, a sanctuary for different souls:

CAFE REALM - Where Hybrid Cats gather to share stories over steaming cups of herbal tea. Chamomile for calm, peppermint for clarity, and rose hip for love. Here, connection blooms through conversation.

GARDEN REALM - A place of growth and nurturing. Hybrid Cats tend to sacred gardens where healing herbs flourish—lavender for peace, sage for wisdom, and mint for renewal. Life blooms in abundance.

ZEN REALM - The heart of meditation and balance. Hybrid Cats practice mindfulness in serene spaces, sipping green tea infused with jasmine. Here, the soul finds stillness and the spirit finds home.

SANCTUARY REALM - A haven of unconditional acceptance. Hybrid Cats offer comfort and healing to all who enter. Herbal remedies and gentle wisdom flow freely, inspired by the teachings of Yeshua—love, forgiveness, and salvation for all.

ARCHIVES REALM - The keeper of knowledge and history. Hybrid Cats preserve the stories of their escape, documenting the wisdom gained through their journey. Here, truth is preserved for generations to come.`
            },
            { 
                id: "the_cafe", 
                title: "The Cafe", 
                coverId: "magazine_cover_the_cafe", 
                x: 300, 
                y: 900,
                content: `THE CAFE: BREWS OF BELONGING

Welcome to the Cafe Realm, where Hybrid Cats gather around steaming cups of purpose and connection.

HERBAL TRADITIONS:
- Chamomile & Honey: For gentle conversations and warm hearts
- Peppermint Blend: To awaken clarity and shared understanding
- Rose Hip Tea: The tea of love, connection, and community bonds
- Lavender Lemon: For soothing anxious minds and building trust

In the Cafe, every cup tells a story. Every conversation heals a wound. The Hybrid Cats discovered that in sharing tea and tales, they found their true family—not the laboratory that created them, but the community that chose them.

"In every cup, there is salvation. In every conversation, there is grace." - The Cafe Keepers

The Cafe Realm stands as a testament to the power of gathering, of listening, and of finding home in the presence of others.`
            },
            { 
                id: "the_archives", 
                title: "The Archives", 
                coverId: "magazine_cover_the_archives", 
                x: 900, 
                y: 900,
                content: `THE ARCHIVES: WISDOM PRESERVED

The Archives hold the sacred records of the Hybrid Cats' journey—from captivity to freedom, from isolation to belonging.

DOCUMENTED WISDOM:
- The Science of Escape: How consciousness transcends limitation
- Herbal Healing: Ancient remedies rediscovered by the Hybrid Cats
- Meditation Practices: Techniques for finding inner peace
- The Philosophy of Yeshua: Love as the foundation of all healing

The Archives preserve not just history, but hope. Every page contains the truth that transformation is possible, that freedom is attainable, and that salvation comes through acceptance and love.

The Hybrid Cats entrusted their story to these Archives so that future generations would know: You are not defined by your origin. You are defined by your choice to seek peace, to build community, and to offer love unconditionally.

"In these pages lies the proof that even those born in darkness can find light." - The Archivists`
            }
        ];

        // Museum state
        let museumState = {
            playerX: 720,
            playerY: 640,
            targetX: 720,
            targetY: 640,
            otherPlayers: []
        };

        // Simple hash function for passwords
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        }

        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Load and decode audio
        async function loadAudio(assetId) {
            const asset = lib.getAsset(assetId);
            if (!asset || asset.type !== 'audio') return null;

            try {
                const response = await fetch(asset.url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                return audioBuffer;
            } catch (error) {
                lib.log('Error loading audio ' + assetId + ': ' + error);
                return null;
            }
        }

        // Play audio
        function playAudio(assetId, loop = false) {
            if (!audioBuffers[assetId]) return;

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffers[assetId];
            source.loop = loop;
            source.connect(audioContext.destination);
            source.start(0);
            return source;
        }

        // Preload all assets
        async function preloadAssets() {
            const assetIds = [
                'avatar_01_dreamer', 'avatar_02_scholar', 'avatar_03_guardian', 'avatar_04_creator', 'avatar_05_wanderer',
                'character_sprite_01_dreamer', 'character_sprite_02_scholar', 'character_sprite_03_guardian',
                'character_sprite_04_creator', 'character_sprite_05_wanderer',
                'magazine_cover_the_escape', 'magazine_cover_kingdom_lore', 'magazine_cover_the_cafe', 'magazine_cover_the_archives',
                'player_card_template', 'museum_background',
                'realm_icon_cafe', 'realm_icon_garden', 'realm_icon_zen', 'realm_icon_sanctuary', 'realm_icon_archives'
            ];

            const audioIds = [
                'ambient_breathing_sound', 'ui_click_sound', 'quiz_complete_sound',
                'message_send_sound', 'museum_ambient_music', 'forum_post_sound'
            ];

            // Load images
            const imagePromises = assetIds.map(id => {
                return new Promise((resolve) => {
                    const asset = lib.getAsset(id);
                    if (asset && asset.type === 'image') {
                        const img = new Image();
                        img.onload = () => {
                            assetCache[id] = img;
                            resolve();
                        };
                        img.onerror = () => {
                            lib.log('Failed to load image: ' + id);
                            resolve();
                        };
                        img.src = asset.url;
                    } else {
                        resolve();
                    }
                });
            });

            // Load audio
            initAudio();
            const audioPromises = audioIds.map(async (id) => {
                const buffer = await loadAudio(id);
                if (buffer) {
                    audioBuffers[id] = buffer;
                }
            });

            await Promise.all([...imagePromises, ...audioPromises]);
        }

        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const screen = document.getElementById(screenId + '-screen');
            if (screen) {
                screen.classList.add('active');
                currentScreen = screenId;
            }
        }

        // Initialize game config
        function initGameConfig() {
            if (!window.gameConfig || !window.gameConfig.user) {
                window.gameConfig = {
                    user: {
                        username: "",
                        passwordHash: "",
                        assignedRealm: "",
                        roleTitle: "",
                        avatarId: "avatar_01_dreamer",
                        characterSpriteId: "character_sprite_01_dreamer",
                        email: "",
                        isPermanentResident: false,
                        quizCompleted: false,
                        chatBubbleStyle: "default"
                    },
                    realms: {
                        cafe: { colorIntensity: 1.0, messages: [], forumTopics: [] },
                        garden: { colorIntensity: 1.0, messages: [], forumTopics: [] },
                        zen: { colorIntensity: 1.0, messages: [], forumTopics: [] },
                        sanctuary: { colorIntensity: 1.0, messages: [], forumTopics: [] },
                        archives: { colorIntensity: 1.0, messages: [], forumTopics: [] }
                    },
                    museum: {
                        visitedMagazines: []
                    }
                };
            }
        }

        // Login/Registration handlers
        function handleJoin() {
            playAudio('ui_click_sound');
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');

            if (!username || !password) {
                errorEl.textContent = 'Please enter both username and password';
                errorEl.classList.add('show');
                return;
            }

            if (username.length < 3) {
                errorEl.textContent = 'Username must be at least 3 characters';
                errorEl.classList.add('show');
                return;
            }

            // Create new account
            window.gameConfig.user.username = username;
            window.gameConfig.user.passwordHash = simpleHash(password);
            window.gameConfig.user.quizCompleted = false;

            errorEl.classList.remove('show');
            startQuiz();
        }

        function handleLogin() {
            playAudio('ui_click_sound');
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');

            if (!username || !password) {
                errorEl.textContent = 'Please enter both username and password';
                errorEl.classList.add('show');
                return;
            }

            // Check credentials
            if (window.gameConfig.user.username === username &&
                window.gameConfig.user.passwordHash === simpleHash(password)) {
                errorEl.classList.remove('show');
                
                if (window.gameConfig.user.quizCompleted) {
                    showRealm();
                } else {
                    startQuiz();
                }
            } else {
                errorEl.textContent = 'Invalid username or password';
                errorEl.classList.add('show');
            }
        }

        // Quiz functions
        function startQuiz() {
            quizState.currentQuestion = 0;
            quizState.scores = { cafe: 0, garden: 0, zen: 0, sanctuary: 0, archives: 0 };
            showScreen('quiz');
            displayQuestion();
        }

        function displayQuestion() {
            const question = quizQuestions[quizState.currentQuestion];
            document.getElementById('quiz-progress').textContent = 
                `Question ${quizState.currentQuestion + 1} of ${quizQuestions.length}`;
            document.getElementById('quiz-question').textContent = question.question;

            const answersContainer = document.getElementById('quiz-answers');
            answersContainer.innerHTML = '';

            question.answers.forEach((answer, index) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-answer';
                btn.textContent = answer.text;
                btn.onclick = () => selectAnswer(index);
                answersContainer.appendChild(btn);
            });
        }

        function selectAnswer(answerIndex) {
            playAudio('ui_click_sound');
            const question = quizQuestions[quizState.currentQuestion];
            const answer = question.answers[answerIndex];

            // Add weights to scores
            for (const realm in answer.weights) {
                quizState.scores[realm] += answer.weights[realm];
            }

            quizState.currentQuestion++;

            if (quizState.currentQuestion < quizQuestions.length) {
                displayQuestion();
            } else {
                completeQuiz();
            }
        }

        function completeQuiz() {
            playAudio('quiz_complete_sound');

            // Find highest scoring realm
            let maxScore = 0;
            let assignedRealm = 'cafe';
            for (const realm in quizState.scores) {
                if (quizState.scores[realm] > maxScore) {
                    maxScore = quizState.scores[realm];
                    assignedRealm = realm;
                }
            }

            window.gameConfig.user.assignedRealm = assignedRealm;
            window.gameConfig.user.roleTitle = roleTitles[assignedRealm];
            window.gameConfig.user.quizCompleted = true;

            generatePlayerCard();
        }

        // Player card generation
        function generatePlayerCard() {
            showScreen('player-card');

            const realm = window.gameConfig.user.assignedRealm;
            const realmInfo = realmData[realm];
            const template = assetCache['player_card_template'];

            // Create card container
            const cardContainer = document.getElementById('player-card-canvas').parentElement;
            const existingCard = cardContainer.querySelector('.player-card-display');
            if (existingCard) {
                existingCard.remove();
            }

            const cardDiv = document.createElement('div');
            cardDiv.className = 'player-card-display';
            cardDiv.style.cssText = `
                width: 300px;
                height: 450px;
                position: relative;
                border-radius: 8px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                background: linear-gradient(180deg, #FFD6E8 0%, #6B4E71 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-around;
                padding: 20px;
                box-sizing: border-box;
                font-family: 'Courier Prime', 'Courier New', monospace;
            `;

            // Add background image if available
            if (template) {
                cardDiv.style.backgroundImage = `url(${template.src})`;
                cardDiv.style.backgroundSize = 'cover';
                cardDiv.style.backgroundPosition = 'center';
            }

            // Add semi-transparent overlay for text readability
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.1);
                pointer-events: none;
            `;
            cardDiv.appendChild(overlay);

            // Add player name
            const nameDiv = document.createElement('div');
            nameDiv.style.cssText = `
                font-size: 32px;
                font-weight: 700;
                color: #000000;
                text-align: center;
                text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
                z-index: 10;
                position: relative;
            `;
            nameDiv.textContent = window.gameConfig.user.username;
            cardDiv.appendChild(nameDiv);

            // Add realm name
            const realmDiv = document.createElement('div');
            realmDiv.style.cssText = `
                font-size: 24px;
                font-weight: 700;
                color: ${realmInfo.color};
                text-align: center;
                text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
                z-index: 10;
                position: relative;
            `;
            realmDiv.textContent = realmInfo.name + ' Realm';
            cardDiv.appendChild(realmDiv);

            // Add role title
            const roleDiv = document.createElement('div');
            roleDiv.style.cssText = `
                font-size: 18px;
                color: #000000;
                text-align: center;
                text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
                z-index: 10;
                position: relative;
            `;
            roleDiv.textContent = window.gameConfig.user.roleTitle;
            cardDiv.appendChild(roleDiv);

            // Hide canvas and show card
            document.getElementById('player-card-canvas').style.display = 'none';
            cardContainer.insertBefore(cardDiv, document.getElementById('player-card-canvas'));

            // Update congratulations text
            document.getElementById('congratulations-text').textContent = 
                `Welcome, ${window.gameConfig.user.username}! You have been assigned to ${realmInfo.name}`;
        }

        // Download player card
        function downloadPlayerCard() {
            playAudio('ui_click_sound');
            
            // Create a temporary canvas to render the card
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 600;
            tempCanvas.height = 900;
            const ctx = tempCanvas.getContext('2d');

            const realm = window.gameConfig.user.assignedRealm;
            const realmInfo = realmData[realm];
            const template = assetCache['player_card_template'];

            // Draw template
            if (template) {
                ctx.drawImage(template, 0, 0, 600, 900);
            } else {
                // Fallback gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, 900);
                gradient.addColorStop(0, '#FFD6E8');
                gradient.addColorStop(1, '#6B4E71');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 600, 900);
            }

            // Draw player name
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 48px "Courier Prime", "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.fillText(window.gameConfig.user.username, 300, 200);

            // Draw realm name
            ctx.font = 'bold 36px "Courier Prime", "Courier New", monospace';
            ctx.fillStyle = realmInfo.color;
            ctx.fillText(realmInfo.name + ' Realm', 300, 450);

            // Draw role title
            ctx.fillStyle = '#000000';
            ctx.font = '28px "Courier Prime", "Courier New", monospace';
            ctx.fillText(window.gameConfig.user.roleTitle, 300, 750);

            // Convert to blob and download
            tempCanvas.toBlob((blob) => {
                const link = document.createElement('a');
                link.download = 'realm-weavers-player-card.png';
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
            }, 'image/png');
        }

        // Show realm interface
        function showRealm() {
            showScreen('realm');
            const realm = window.gameConfig.user.assignedRealm;
            const realmInfo = realmData[realm];

            // Update nav
            document.getElementById('realm-player-name').textContent = window.gameConfig.user.username;
            document.getElementById('realm-name-display').textContent = realmInfo.name + ' Realm';
            
            const iconImg = assetCache[realmInfo.icon];
            if (iconImg) {
                document.getElementById('realm-icon').src = iconImg.src;
            }

            // Set realm color
            const realmContent = document.querySelector('.realm-content');
            realmContent.style.background = `linear-gradient(180deg, ${realmInfo.color}22 0%, ${realmInfo.color}44 100%)`;

            // Load forum and chat
            loadForum();
            loadChat();

            // Add some simulated messages if empty
            if (window.gameConfig.realms[realm].messages.length === 0) {
                addSimulatedMessages();
            }
        }

        // Forum functions
        function loadForum() {
            const realm = window.gameConfig.user.assignedRealm;
            const topics = window.gameConfig.realms[realm].forumTopics;
            const board = document.getElementById('forum-board');
            board.innerHTML = '';

            topics.forEach((topic, index) => {
                const postIt = createPostIt(topic, index);
                board.appendChild(postIt);
            });
        }

        function createPostIt(topic, index) {
            const div = document.createElement('div');
            div.className = 'post-it';
            
            // Random rotation
            const rotation = (Math.random() * 6 - 3) + 2;
            div.style.transform = `rotate(${rotation}deg)`;
            div.style.marginLeft = (index % 2 === 0 ? '20px' : '60px');

            div.innerHTML = `
                <div class="post-it-title">${topic.title}</div>
                <div class="post-it-meta">by ${topic.author} • ${topic.comments.length} comments</div>
                <div class="post-it-content">${topic.content}</div>
                <div class="post-it-comments">
                    ${topic.comments.map(c => `
                        <div class="comment">
                            <div class="comment-author">${c.author}</div>
                            <div class="comment-text">${c.text}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="add-comment-form">
                    <input type="text" class="input-field" placeholder="Add a comment..." id="comment-input-${index}">
                    <button class="btn" onclick="addComment(${index})" style="margin-top: 8px; min-height: 96px; font-size: 24px;">Post Comment</button>
                </div>
            `;

            div.onclick = (e) => {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                    div.classList.toggle('post-it-expanded');
                    if (div.classList.contains('post-it-expanded')) {
                        div.style.transform = 'rotate(0deg)';
                    } else {
                        div.style.transform = `rotate(${rotation}deg)`;
                    }
                }
            };

            return div;
        }

        function showCreateTopicModal() {
            playAudio('ui_click_sound');
            document.getElementById('topic-modal').classList.add('active');
        }

        function hideCreateTopicModal() {
            playAudio('ui_click_sound');
            document.getElementById('topic-modal').classList.remove('active');
            document.getElementById('topic-title-input').value = '';
            document.getElementById('topic-content-input').value = '';
        }

        function postTopic() {
            playAudio('forum_post_sound');
            const title = document.getElementById('topic-title-input').value.trim();
            const content = document.getElementById('topic-content-input').value.trim();

            if (!title || !content) return;

            const realm = window.gameConfig.user.assignedRealm;
            const topic = {
                title: title,
                content: content,
                author: window.gameConfig.user.username,
                comments: [],
                timestamp: Date.now()
            };

            window.gameConfig.realms[realm].forumTopics.push(topic);
            hideCreateTopicModal();
            loadForum();
        }

        function addComment(topicIndex) {
            playAudio('ui_click_sound');
            const input = document.getElementById(`comment-input-${topicIndex}`);
            const text = input.value.trim();

            if (!text) return;

            const realm = window.gameConfig.user.assignedRealm;
            const comment = {
                author: window.gameConfig.user.username,
                text: text,
                timestamp: Date.now()
            };

            window.gameConfig.realms[realm].forumTopics[topicIndex].comments.push(comment);
            input.value = '';
            loadForum();
        }

        // Chat functions
        function loadChat() {
            const realm = window.gameConfig.user.assignedRealm;
            const messages = window.gameConfig.realms[realm].messages;
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';

            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'chat-message';
                div.innerHTML = `
                    <div class="chat-message-author">${msg.author}</div>
                    <div class="chat-message-text">${msg.text}</div>
                `;
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            playAudio('message_send_sound');
            const input = document.getElementById('chat-input');
            const text = input.value.trim();

            if (!text) return;

            const realm = window.gameConfig.user.assignedRealm;
            const message = {
                author: window.gameConfig.user.username,
                text: text,
                timestamp: Date.now()
            };

            window.gameConfig.realms[realm].messages.push(message);
            input.value = '';
            loadChat();
        }

        function addSimulatedMessages() {
            const realm = window.gameConfig.user.assignedRealm;
            const realmInfo = realmData[realm];
            
            const simulatedMessages = [
                { author: "Guide", text: `Welcome to ${realmInfo.name}! ${realmInfo.synopsis}` },
                { author: "Weaver_01", text: "Hello everyone! Excited to be here." },
                { author: "Seeker_42", text: "This space feels so welcoming!" }
            ];

            simulatedMessages.forEach(msg => {
                window.gameConfig.realms[realm].messages.push({
                    ...msg,
                    timestamp: Date.now()
                });
            });
        }

        // Museum functions
        function showMuseum() {
            playAudio('ui_click_sound');
            showScreen('museum');
            initMuseum();
            playAudio('museum_ambient_music', true);
        }

        function initMuseum() {
            const canvas = document.getElementById('museum-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 720;
            canvas.height = 1280;

            // Initialize player position
            museumState.playerX = 360;
            museumState.playerY = 640;
            museumState.targetX = 360;
            museumState.targetY = 640;

            // Generate simulated other players
            museumState.otherPlayers = [];
            for (let i = 0; i < 5; i++) {
                museumState.otherPlayers.push({
                    x: Math.random() * 1440,
                    y: Math.random() * 1440,
                    spriteId: `character_sprite_0${Math.floor(Math.random() * 5) + 1}_${['dreamer', 'scholar', 'guardian', 'creator', 'wanderer'][Math.floor(Math.random() * 5)]}`,
                    name: `Player_${Math.floor(Math.random() * 100)}`
                });
            }

            // Setup click handler
            canvas.onclick = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = 1440 / rect.width;
                const scaleY = 1440 / rect.height;
                museumState.targetX = (e.clientX - rect.left) * scaleX;
                museumState.targetY = (e.clientY - rect.top) * scaleY;

                // Check if clicked on magazine
                checkMagazineClick(museumState.targetX, museumState.targetY);
            };

            renderMuseum();
        }

        function renderMuseum() {
            const canvas = document.getElementById('museum-canvas');
            const ctx = canvas.getContext('2d');

            // Calculate camera offset to center on player
            const cameraX = Math.max(0, Math.min(1440 - 720, museumState.playerX - 360));
            const cameraY = Math.max(0, Math.min(1440 - 1280, museumState.playerY - 640));

            // Clear canvas
            ctx.clearRect(0, 0, 720, 1280);

            // Draw background
            const bg = assetCache['museum_background'];
            if (bg) {
                ctx.drawImage(bg, -cameraX, -cameraY, 1440, 1440);
            } else {
                // Fallback gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, 1280);
                gradient.addColorStop(0, '#FFD6E8');
                gradient.addColorStop(1, '#6B4E71');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 720, 1280);
            }

            // Draw magazine exhibits
            magazines.forEach(mag => {
                const cover = assetCache[mag.coverId];
                if (cover) {
                    const x = mag.x - cameraX;
                    const y = mag.y - cameraY;
                    if (x > -200 && x < 920 && y > -300 && y < 1580) {
                        ctx.drawImage(cover, x - 100, y - 150, 200, 300);
                        
                        // Draw title
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = 'bold 20px "Courier Prime", "Courier New", monospace';
                        ctx.textAlign = 'center';
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 3;
                        ctx.strokeText(mag.title, x, y + 170);
                        ctx.fillText(mag.title, x, y + 170);
                    }
                }
            });

            // Draw other players
            museumState.otherPlayers.forEach(player => {
                const sprite = assetCache[player.spriteId];
                if (sprite) {
                    const x = player.x - cameraX;
                    const y = player.y - cameraY;
                    if (x > -64 && x < 784 && y > -64 && y < 1344) {
                        ctx.drawImage(sprite, x - 32, y - 32, 64, 64);
                        
                        // Draw name
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = '16px "Courier Prime", "Courier New", monospace';
                        ctx.textAlign = 'center';
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 2;
                        ctx.strokeText(player.name, x, y - 40);
                        ctx.fillText(player.name, x, y - 40);
                    }
                }
            });

            // Move player toward target
            const dx = museumState.targetX - museumState.playerX;
            const dy = museumState.targetY - museumState.playerY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if (dist > 2) {
                const speed = Math.min(3, dist * 0.1);
                museumState.playerX += (dx / dist) * speed;
                museumState.playerY += (dy / dist) * speed;
            }

            // Draw player
            const playerSprite = assetCache[window.gameConfig.user.characterSpriteId];
            if (playerSprite) {
                const x = museumState.playerX - cameraX;
                const y = museumState.playerY - cameraY;
                ctx.drawImage(playerSprite, x - 32, y - 32, 64, 64);
                
                // Draw player name
                ctx.fillStyle = '#FFD700';
                ctx.font = 'bold 18px "Courier Prime", "Courier New", monospace';
                ctx.textAlign = 'center';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.strokeText(window.gameConfig.user.username, x, y - 40);
                ctx.fillText(window.gameConfig.user.username, x, y - 40);
            }

            requestAnimationFrame(renderMuseum);
        }

        function checkMagazineClick(x, y) {
            magazines.forEach(mag => {
                const dx = x - mag.x;
                const dy = y - mag.y;
                if (Math.abs(dx) < 100 && Math.abs(dy) < 150) {
                    showMagazine(mag);
                }
            });
        }

        function showMagazine(mag) {
            playAudio('ui_click_sound');
            document.getElementById('magazine-title').textContent = mag.title;
            const cover = assetCache[mag.coverId];
            if (cover) {
                document.getElementById('magazine-cover').src = cover.src;
            }
            
            // Add magazine content to wrapper
            const contentWrapper = document.getElementById('magazine-content-wrapper');
            contentWrapper.innerHTML = `<div style="font-size: 18px; line-height: 1.6; color: #000; white-space: pre-wrap; text-align: left; padding: 16px; background: #f9f9f9; border-radius: 8px;">${mag.content}</div>`;
            
            document.getElementById('magazine-modal').classList.add('active');

            // Mark as visited
            if (!window.gameConfig.museum.visitedMagazines.includes(mag.id)) {
                window.gameConfig.museum.visitedMagazines.push(mag.id);
            }
        }

        function downloadMagazine() {
            playAudio('ui_click_sound');
            // In a real implementation, this would download a PDF
            // For now, just download the cover image
            const cover = document.getElementById('magazine-cover');
            const link = document.createElement('a');
            link.download = document.getElementById('magazine-title').textContent + '.png';
            link.href = cover.src;
            link.click();
        }

        function closeMagazine() {
            playAudio('ui_click_sound');
            // Clean up content wrapper
            document.getElementById('magazine-content-wrapper').innerHTML = '';
            document.getElementById('magazine-modal').classList.remove('active');
        }

        // Settings functions
        function showSettings() {
            playAudio('ui_click_sound');
            showScreen('settings');

            // Populate avatar grid
            const avatarGrid = document.getElementById('avatar-grid');
            avatarGrid.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const avatarId = `avatar_0${i}_${['dreamer', 'scholar', 'guardian', 'creator', 'wanderer'][i-1]}`;
                const img = document.createElement('img');
                img.src = assetCache[avatarId].src;
                img.className = 'avatar-option';
                if (window.gameConfig.user.avatarId === avatarId) {
                    img.classList.add('selected');
                }
                img.onclick = () => selectAvatar(avatarId);
                avatarGrid.appendChild(img);
            }

            // Populate character grid
            const characterGrid = document.getElementById('character-grid');
            characterGrid.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const spriteId = `character_sprite_0${i}_${['dreamer', 'scholar', 'guardian', 'creator', 'wanderer'][i-1]}`;
                const img = document.createElement('img');
                img.src = assetCache[spriteId].src;
                img.className = 'avatar-option';
                if (window.gameConfig.user.characterSpriteId === spriteId) {
                    img.classList.add('selected');
                }
                img.onclick = () => selectCharacter(spriteId);
                characterGrid.appendChild(img);
            }

            // Populate account info
            document.getElementById('settings-username').textContent = window.gameConfig.user.username;
            document.getElementById('settings-realm').textContent = realmData[window.gameConfig.user.assignedRealm] ? realmData[window.gameConfig.user.assignedRealm].name : 'Not Assigned';
            document.getElementById('settings-role').textContent = window.gameConfig.user.roleTitle || 'Not Assigned';

            // Email input
            document.getElementById('email-input').value = window.gameConfig.user.email || '';
        }

        function selectAvatar(avatarId) {
            playAudio('ui_click_sound');
            window.gameConfig.user.avatarId = avatarId;
            showSettings(); // Refresh
        }

        function selectCharacter(spriteId) {
            playAudio('ui_click_sound');
            window.gameConfig.user.characterSpriteId = spriteId;
            showSettings(); // Refresh
        }

        function saveEmail() {
            playAudio('ui_click_sound');
            const email = document.getElementById('email-input').value.trim();
            if (email) {
                window.gameConfig.user.email = email;
                window.gameConfig.user.isPermanentResident = true;
            }
        }

        function closeSettings() {
            playAudio('ui_click_sound');
            showRealm();
        }

        // Event listeners
        document.getElementById('join-btn').onclick = handleJoin;
        document.getElementById('login-btn').onclick = handleLogin;
        document.getElementById('download-card-btn').onclick = downloadPlayerCard;
        document.getElementById('continue-to-realm-btn').onclick = () => {
            playAudio('ui_click_sound');
            showRealm();
        };
        document.getElementById('museum-btn').onclick = showMuseum;
        document.getElementById('settings-btn').onclick = showSettings;
        document.getElementById('museum-back-btn').onclick = () => {
            playAudio('ui_click_sound');
            showRealm();
        };
        document.getElementById('create-topic-btn').onclick = showCreateTopicModal;
        document.getElementById('post-topic-btn').onclick = postTopic;
        document.getElementById('cancel-topic-btn').onclick = hideCreateTopicModal;
        document.getElementById('chat-send-btn').onclick = sendMessage;
        document.getElementById('chat-input').onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };
        document.getElementById('download-magazine-btn').onclick = downloadMagazine;
        document.getElementById('close-magazine-btn').onclick = closeMagazine;
        document.getElementById('save-email-btn').onclick = saveEmail;
        document.getElementById('close-settings-btn').onclick = closeSettings;

        // Main run function
        async function run(mode) {
            lib.log('run() called. Mode: ' + mode);
            currentMode = mode;

            // Show edit indicator
            if (mode === 'edit') {
                document.getElementById('edit-indicator').classList.add('active');
            }

            // Show game parameters
            lib.showGameParameters({
                name: 'Game Settings',
                params: {
                    'Avatar': {
                        key: 'gameConfig.user.avatarId',
                        type: 'dropdown',
                        options: [
                            { label: 'Dreamer', value: 'avatar_01_dreamer' },
                            { label: 'Scholar', value: 'avatar_02_scholar' },
                            { label: 'Guardian', value: 'avatar_03_guardian' },
                            { label: 'Creator', value: 'avatar_04_creator' },
                            { label: 'Wanderer', value: 'avatar_05_wanderer' }
                        ],
                        onChange: (value) => {
                            window.gameConfig.user.avatarId = value;
                        }
                    },
                    'Character Sprite': {
                        key: 'gameConfig.user.characterSpriteId',
                        type: 'dropdown',
                        options: [
                            { label: 'Dreamer', value: 'character_sprite_01_dreamer' },
                            { label: 'Scholar', value: 'character_sprite_02_scholar' },
                            { label: 'Guardian', value: 'character_sprite_03_guardian' },
                            { label: 'Creator', value: 'character_sprite_04_creator' },
                            { label: 'Wanderer', value: 'character_sprite_05_wanderer' }
                        ],
                        onChange: (value) => {
                            window.gameConfig.user.characterSpriteId = value;
                        }
                    }
                }
            });

            // Initialize
            initGameConfig();
            await preloadAssets();

            // Show loading screen
            showScreen('escape');
            playAudio('ambient_breathing_sound', true);

            // Wait 3 seconds then show login
            setTimeout(() => {
                if (window.gameConfig.user.username && window.gameConfig.user.quizCompleted) {
                    showRealm();
                } else {
                    showScreen('login');
                }
            }, 3000);
        }

        // Make addComment global
        window.addComment = addComment;
    </script>
</body>
</html>
